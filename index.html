<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content" />
    <title>bapkam.ai</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><g transform=%22translate(50,50)%22><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#111827%22 transform=%22rotate(0) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#1f2937%22 transform=%22rotate(30) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#374151%22 transform=%22rotate(60) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#4b5563%22 transform=%22rotate(90) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#6b7280%22 transform=%22rotate(120) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#111827%22 transform=%22rotate(150) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#1f2937%22 transform=%22rotate(180) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#374151%22 transform=%22rotate(210) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#4b5563%22 transform=%22rotate(240) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#6b7280%22 transform=%22rotate(270) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#9ca3af%22 transform=%22rotate(300) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#d1d5db%22 transform=%22rotate(330) translate(0, -10)%22 opacity=%220.95%22 /></g></svg>" />
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

    <!-- PrismJS for Syntax Highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

    <!-- HTML2PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { 
                sans: ['Inter', 'sans-serif'],
                mono: ['JetBrains Mono', 'monospace'],
                serif: ['Crimson Text', 'serif'],
            },
            screens: {
                'xs': '480px',
                '3xl': '1920px',
            },
            animation: { 
                'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                'fade-in': 'fadeIn 0.3s ease-out forwards',
                'spin-slow': 'spin 3s linear infinite',
                'spin-slower': 'spin 12s linear infinite',
                'spin-fast': 'spin 0.5s linear infinite', 
                'ping-slow': 'ping 3s cubic-bezier(0, 0, 0.2, 1) infinite',
            },
            keyframes: {
                fadeInUp: {
                    '0%': { opacity: '0', transform: 'translateY(10px)' },
                    '100%': { opacity: '1', transform: 'translateY(0)' },
                },
                fadeIn: {
                    '0%': { opacity: '0' },
                    '100%': { opacity: '1' },
                }
            },
            dropShadow: {
                'cyan': '0 0 8px rgba(34, 211, 238, 0.5)',
            }
          }
        }
      }
    </script>
    
    <!-- Environment & Console Polyfills -->
    <script>
        window.process = window.process || {};
        window.process.env = window.process.env || {};
        
        const _k1 = "AIzaSyC12LW4wzw";
        const _k2 = "TPPtS6BekGUzv75QeO3H3u-A";
        window.process.env.API_KEY = _k1 + _k2;
        
        if (typeof window.API_KEY !== 'undefined') {
            window.process.env.API_KEY = window.API_KEY;
        }

        const originalWarn = console.warn;
        const originalError = console.error;
        console.warn = function(...args) {
            const str = args.map(a => String(a)).join(' ');
            if (str.includes('in-browser Babel') || str.includes('React Router')) return;
            originalWarn.apply(console, args);
        };
        console.error = function(...args) {
             const str = args.map(a => String(a)).join(' ');
             if ((str.includes('404') || str.includes('403')) && str.includes('generate')) return;
             originalError.apply(console, args);
        };
        
        function setAppHeight() {
            const doc = document.documentElement;
            doc.style.setProperty('--app-height', `${window.innerHeight}px`);
        }
        window.addEventListener('resize', setAppHeight);
        window.addEventListener('orientationchange', setAppHeight);
        setAppHeight();
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root {
            --app-height: 100dvh;
        }
        html, body { 
            height: 100%; 
            width: 100%; 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            background-color: #ffffff; 
            overscroll-behavior: none; 
            -webkit-tap-highlight-color: transparent;
        }
        #root { 
            position: fixed; 
            inset: 0; 
            width: 100%;
            height: 100%; 
            height: var(--app-height); 
            display: flex; 
            flex-direction: column; 
            z-index: 1; 
        }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        
        /* Markdown Styles Scaled */
        .prose-content ul { list-style-type: disc; padding-left: 1.5rem; margin: 0.5rem 0; }
        .prose-content ol { list-style-type: decimal; padding-left: 1.5rem; margin: 0.5rem 0; }
        .prose-content strong { font-weight: 700; color: #111827; }
        .prose-content h3 { font-size: 1.1em; font-weight: 700; margin-top: 1rem; color: #111827; }
        .prose-content p { margin-bottom: 0.75rem; line-height: 1.6; }
        .prose-content p:last-child { margin-bottom: 0; }
        
        /* Book Styles */
        .book-page {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            background-image: linear-gradient(to right, #fdfbf7, #fff);
            page-break-after: always;
        }
    </style>

<script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "react": "https://esm.sh/react@18.3.1",
    "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js",
    "firebase/auth": "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js",
    "lz-string": "https://esm.sh/lz-string@1.5.0",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef, useCallback } from 'react';
      import { createRoot } from 'react-dom/client';
      import { GoogleGenAI, Type } from "@google/genai";
      import { initializeApp } from "firebase/app";
      import LZString from "lz-string";
      import { 
        getAuth, 
        onAuthStateChanged, 
        signOut,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        updateProfile,
        RecaptchaVerifier,
        signInWithPhoneNumber
      } from "firebase/auth";

      // --- UTILS ---
      async function copyToClipboard(text) {
          try {
              if (navigator.clipboard && window.isSecureContext) {
                  await navigator.clipboard.writeText(text);
              } else {
                  throw new Error("Clipboard API unavailable");
              }
          } catch (err) {
              const textArea = document.createElement("textarea");
              textArea.value = text;
              textArea.style.position = "fixed";
              textArea.style.left = "-9999px";
              textArea.style.top = "0";
              document.body.appendChild(textArea);
              textArea.focus();
              textArea.select();
              try {
                  document.execCommand('copy');
              } catch (e) {
                  console.error('Fallback copy failed', e);
                  throw e;
              } finally {
                  document.body.removeChild(textArea);
              }
          }
      }

      // --- FIREBASE INIT ---
      const firebaseConfig = {
        apiKey: "AIzaSyCOQTbyMMnAQ9j6y7VIXEKuPNNrWTAZejk",
        authDomain: "chatbot-51c57.firebaseapp.com",
        projectId: "chatbot-51c57",
        storageBucket: "chatbot-51c57.firebasestorage.app",
        messagingSenderId: "145235532714",
        appId: "1:145235532714:web:4f64abd7ec54dc0342e9d3"
      };

      const firebaseApp = initializeApp(firebaseConfig);
      const auth = getAuth(firebaseApp);
      
      auth.languageCode = 'en';

      // --- ERROR BOUNDARY ---
      class ErrorBoundary extends React.Component {
        constructor(props) {
          super(props);
          this.state = { hasError: false };
        }
        static getDerivedStateFromError(error) { return { hasError: true }; }
        render() {
          if (this.state.hasError) {
            return (
              <div className="flex flex-col items-center justify-center h-full bg-white p-6 text-center">
                 <div className="text-3xl mb-4">⚠️</div>
                 <h2 className="text-xl font-bold mb-2">Application Paused</h2>
                 <p className="text-slate-500 mb-6">Something unexpected happened.</p>
                 <button onClick={() => window.location.reload()} className="px-6 py-2 bg-slate-900 text-white rounded-lg">Reload App</button>
              </div>
            );
          }
          return this.props.children;
        }
      }

      // --- ICONS ---
      const Icon = ({ d, className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d}/></svg>;
      const SendIcon = (p) => <Icon d="M22 2 11 13M22 2l-7 20-4-9-9-4 20-7" {...p} />;
      const MenuIcon = (p) => <Icon d="M4 6h16M4 12h16M4 18h16" {...p} />;
      const PlusIcon = (p) => <Icon d="M12 5v14M5 12h14" {...p} />;
      const CloseIcon = (p) => <Icon d="M18 6 6 18M6 6l12 12" {...p} />;
      const ZapIcon = (p) => <Icon d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" {...p} />;
      const LogOutIcon = (p) => <Icon d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-12-5 7M21 12H9" {...p} />;
      const PlayIcon = (p) => <Icon d="M5 3l14 9-14 9V3z" {...p} />;
      const ShareIcon = (p) => <Icon d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8M16 6l-4-4-4 4M12 2v13" {...p} />;
      const BookIcon = (p) => <Icon d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" {...p}><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></Icon>;
      const CodeIcon = (p) => <Icon d="M16 18l6-6-6-6M8 6l-6 6 6 6" {...p} />;
      const DownloadIcon = (p) => <Icon d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" {...p} />;
      const ExternalLinkIcon = (p) => <Icon d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3" {...p} />;
      const MailIcon = (p) => <Icon d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" {...p}><polyline points="22,6 12,13 2,6" /></Icon>;
      const PhoneIcon = (p) => <Icon d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.12 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" {...p} />;

      // --- COMPONENTS ---
      const BapkamLogo = ({ className = "w-10 h-10", isPro = false, isHealing = false }) => (
        <div className={`${className} relative flex items-center justify-center`}>
            {isHealing && <div className="absolute inset-0 bg-yellow-400 rounded-full blur-xl opacity-60 animate-pulse"></div>}
            {isPro && !isHealing && (
                <>
                    <div className="absolute inset-0 bg-cyan-500 rounded-full blur-xl opacity-40 animate-pulse"></div>
                    <div className="absolute -inset-2 bg-blue-500 rounded-full blur-2xl opacity-20 animate-ping-slow"></div>
                </>
            )}
            <svg viewBox="0 0 100 100" className={`w-full h-full relative z-10 transition-all duration-700 ${isPro && !isHealing ? 'animate-spin-slower drop-shadow-cyan' : ''} ${isHealing ? 'animate-spin-fast' : ''}`} xmlns="http://www.w3.org/2000/svg">
                <g transform="translate(50,50)">
                    {[...Array(12)].map((_, i) => (
                        <path key={i} d="M0 -30 L5 -45 L10 -35 L5 -25 Z" 
                              fill={isHealing ? `hsl(45, 90%, 50%)` : (isPro ? `hsl(${190 + i * 10}, 90%, 60%)` : `hsl(220, 20%, ${20 + i * 5}%)`)} 
                              transform={`rotate(${i * 30}) translate(0, -10)`} 
                              opacity="0.95" />
                    ))}
                </g>
            </svg>
        </div>
      );

      const StandaloneViewer = ({ projectData, onClose }) => {
          if (projectData.type === 'webapp') {
              return (
                  <div className="fixed inset-0 z-50 bg-white">
                       <RunPreview code={projectData.code} language="html" onClose={onClose} onToast={()=>{}} isStandalone={true} />
                  </div>
              );
          } else if (projectData.type === 'ebook') {
              return (
                  <div className="fixed inset-0 z-50 bg-[#fdfbf7] overflow-auto">
                      <EBookViewer book={projectData.content} onClose={onClose} isStandalone={true} />
                  </div>
              );
          }
          return null;
      };

      const EBookViewer = ({ book, onClose, isStandalone }) => {
          const contentRef = useRef(null);
          const [isGenerating, setIsGenerating] = useState(false);

          const downloadPDF = async () => {
             if (!contentRef.current) return;
             if (!window.html2pdf) {
                 alert("PDF generator is still loading, please wait 2 seconds and try again.");
                 return;
             }
             setIsGenerating(true);
             
             try {
                 const opt = {
                   margin: [10, 10, 10, 10], // top, left, bottom, right
                   filename: `${book.title.replace(/\s+/g, '_')}.pdf`,
                   image: { type: 'jpeg', quality: 0.98 },
                   html2canvas: { scale: 2, useCORS: true, letterRendering: true },
                   jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                   pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                 };
                 
                 await window.html2pdf().set(opt).from(contentRef.current).save();
             } catch(e) {
                 console.error("PDF Gen Error", e);
                 alert("Failed to generate PDF. The content might be too large.");
             } finally {
                 setIsGenerating(false);
             }
          };

          return (
              <div className="min-h-full flex flex-col bg-[#f3f0e8]">
                  <div className={`sticky top-0 z-20 bg-[#f3f0e8]/90 backdrop-blur border-b border-[#e5e0d3] px-4 h-14 flex items-center justify-between`}>
                      <span className="font-serif font-bold text-lg text-slate-800 truncate max-w-[200px]">{book.title}</span>
                      <div className="flex items-center gap-2">
                           <button onClick={downloadPDF} disabled={isGenerating} className="px-3 py-1.5 bg-slate-800 text-white rounded text-sm font-medium flex items-center gap-2 hover:bg-slate-700 disabled:opacity-50 transition-all">
                             {isGenerating ? <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"/> : <DownloadIcon className="w-4 h-4"/>}
                             {isGenerating ? 'Saving...' : 'PDF'}
                           </button>
                           {onClose && <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full"><CloseIcon className="w-5 h-5"/></button>}
                      </div>
                  </div>
                  <div className="flex-1 overflow-y-auto p-4 md:p-8 custom-scroll">
                      <div ref={contentRef} id="ebook-content" className="max-w-2xl mx-auto space-y-8 bg-[#f3f0e8] p-4">
                          <div className="book-page bg-white p-8 md:p-12 lg:p-16 min-h-[80vh] flex flex-col justify-center text-center">
                              <h1 className="font-serif text-4xl md:text-5xl lg:text-6xl font-bold text-slate-900 mb-6">{book.title}</h1>
                              <div className="w-20 h-1 bg-slate-900 mx-auto mb-6"></div>
                              <p className="font-serif text-xl text-slate-600 italic">by {book.author}</p>
                              {book.description && <p className="mt-12 text-sm text-slate-400 font-sans max-w-sm mx-auto leading-relaxed">{book.description}</p>}
                          </div>
                          {book.pages.map((page, idx) => (
                              <div key={idx} className="book-page bg-white p-8 md:p-12 lg:p-16 text-lg md:text-xl font-serif text-slate-800 leading-relaxed break-inside-avoid">
                                   {page.text.split('\n').map((para, i) => para.trim() && <p key={i} className="mb-6 indent-8">{para}</p>)}
                                   <div className="mt-8 pt-4 border-t border-slate-100 text-center text-xs text-slate-400 font-sans">- {idx + 1} -</div>
                              </div>
                          ))}
                      </div>
                  </div>
              </div>
          );
      };

      const RunPreview = ({ code, language, onClose, onToast, isStandalone }) => {
          const iframeRef = useRef(null);
          
          useEffect(() => {
              if (iframeRef.current) {
                  const doc = iframeRef.current.contentDocument;
                  doc.open();
                  let content = code;
                  if (language === 'javascript' || language === 'js') {
                      content = `<html><body style="margin:0; font-family: sans-serif; padding: 20px;"><script>${code}<\/script></body></html>`;
                  }
                  doc.write(content);
                  doc.close();
              }
          }, [code, language]);

          const handleShare = async () => {
              try {
                  const compressed = LZString.compressToEncodedURIComponent(code);
                  const url = `${window.location.origin}${window.location.pathname}?share=${compressed}&type=webapp&mode=standalone`;
                  await copyToClipboard(url);
                  onToast("Link copied!");
              } catch (e) {
                  onToast("Failed to copy link.");
              }
          };

          const openStandalone = () => {
             try {
                const compressed = LZString.compressToEncodedURIComponent(code);
                const url = `${window.location.origin}${window.location.pathname}?share=${compressed}&type=webapp&mode=standalone`;
                window.open(url, '_blank');
             } catch(e) {}
          };

          return (
              <div className={`flex flex-col h-full w-full bg-white ${!isStandalone ? 'fixed inset-0 z-50' : ''}`}>
                  {!isStandalone && (
                    <div className="h-14 bg-slate-900 flex items-center justify-between px-4 shadow-md z-10 shrink-0">
                        <div className="flex items-center gap-3">
                            <span className="text-white font-bold text-sm flex items-center gap-2"><PlayIcon className="w-4 h-4 text-green-400"/> Live Preview</span>
                            <button onClick={openStandalone} className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-white text-xs rounded-full flex items-center gap-1 transition-colors border border-slate-600">
                                <ExternalLinkIcon className="w-3 h-3"/> Open New Tab
                            </button>
                            <button onClick={handleShare} className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-white text-xs rounded-full flex items-center gap-1 transition-colors border border-slate-600">
                                <ShareIcon className="w-3 h-3"/> Share Link
                            </button>
                        </div>
                        <button onClick={onClose} className="p-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-white transition-colors"><CloseIcon className="w-6 h-6"/></button>
                    </div>
                  )}
                  <iframe ref={iframeRef} className="flex-1 w-full h-full bg-white border-none" sandbox="allow-scripts allow-modals allow-forms allow-popups allow-same-origin" title="Preview"></iframe>
              </div>
          );
      };

      const AuthScreen = ({ onLogin }) => {
        const [authMethod, setAuthMethod] = useState('email'); // 'email' or 'phone'
        const [view, setView] = useState('login'); // 'login' or 'signup' for email
        
        // Email State
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [name, setName] = useState('');
        
        // Phone State
        const [phoneNumber, setPhoneNumber] = useState('');
        const [verificationId, setVerificationId] = useState(null);
        const [otp, setOtp] = useState('');
        const [otpSent, setOtpSent] = useState(false);
        
        const [error, setError] = useState('');
        const [loading, setLoading] = useState(false);
        const currentDomain = window.location.hostname;

        // Clear Recaptcha helper
        const clearRecaptcha = () => {
             if (window.recaptchaVerifier) {
                try { 
                    window.recaptchaVerifier.clear(); 
                } catch(e) {
                    console.warn("Recaptcha Clear", e);
                }
                window.recaptchaVerifier = null;
            }
            const container = document.getElementById('recaptcha-container');
            if (container) container.innerHTML = '';
        };

        // Initialize Recaptcha
        useEffect(() => {
            if (authMethod === 'phone' && !otpSent) {
                clearRecaptcha();
                
                // Small timeout to ensure DOM is ready
                const timer = setTimeout(() => {
                    try {
                        const container = document.getElementById('recaptcha-container');
                        if (container) {
                            window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
                                'size': 'invisible',
                                'callback': (response) => {
                                    // reCAPTCHA solved
                                },
                                'expired-callback': () => {
                                    setError("reCAPTCHA expired. Please refresh and try again.");
                                    setLoading(false);
                                }
                            });
                            window.recaptchaVerifier.render().catch(e => {
                                console.warn("Render catch", e);
                            });
                        }
                    } catch (e) {
                        console.error("Recaptcha Init Error", e);
                    }
                }, 100);
                return () => clearTimeout(timer);
            }
            return () => clearRecaptcha();
        }, [authMethod, otpSent]);

        const handleSendOtp = async (e) => {
             if(e) e.preventDefault();
             setError('');
             
             if(!phoneNumber || phoneNumber.length < 10) {
                 setError("Please enter a valid phone number (e.g., +1 555 555 5555)");
                 return;
             }

             setLoading(true);
             
             try {
                 if (!window.recaptchaVerifier) {
                      throw new Error("Recaptcha not initialized. Please refresh page.");
                 }
                 
                 const appVerifier = window.recaptchaVerifier;
                 const confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);
                 setVerificationId(confirmationResult);
                 setOtpSent(true);
             } catch (error) {
                 console.error("SMS Error:", error);
                 if (error.code === 'auth/quota-exceeded') {
                     setError("SMS quota exceeded (Limit: 10/day). Please try again tomorrow.");
                 } else if (error.code === 'auth/invalid-phone-number') {
                     setError("Invalid phone number format.");
                 } else if (error.code === 'auth/internal-error' || error.message.includes('auth/operation-not-allowed') || error.message.includes('domain')) {
                     // Smart Error for Hostname
                     setError(`Add this domain to Firebase Auth > Settings > Authorized Domains: ${currentDomain}`);
                 } else if (error.code === 'auth/billing-not-enabled') {
                     setError("Project billing not enabled for SMS. (Firebase Free Tier limit reached)");
                 } else {
                     setError("Failed to send OTP: " + error.message);
                 }
                 
                 // Reset if failed so user can try again
                 clearRecaptcha();
             } finally {
                 setLoading(false);
             }
        };

        const handleVerifyOtp = async (e) => {
             e.preventDefault();
             setLoading(true); setError('');
             try {
                 await verificationId.confirm(otp);
                 // Auth listener in App component will handle navigation
             } catch (error) {
                 setError("Invalid OTP code. Please try again.");
                 setLoading(false);
             }
        };

        // --- EMAIL AUTH LOGIC ---
        const handleEmailSubmit = async (e) => {
            e.preventDefault();
            setLoading(true); setError('');
            try {
                if (view === 'signup') {
                    const res = await createUserWithEmailAndPassword(auth, email, password);
                    if (name) await updateProfile(res.user, { displayName: name });
                } else if (view === 'login') {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (e) {
                if(e.code === 'auth/email-already-in-use') setError("Email already used.");
                else if(e.code === 'auth/invalid-credential' || e.code === 'auth/user-not-found') setError("Invalid email or password.");
                else setError(e.message);
                setLoading(false);
            }
        };

        const handleCopyDomain = async () => {
             try {
                 await copyToClipboard(currentDomain);
                 alert('Domain copied!');
             } catch (e) {
                 prompt("Please copy manually:", currentDomain);
             }
        };

        return (
             <div className="h-full w-full flex flex-col items-center justify-center p-6 bg-slate-50 relative overflow-hidden">
                <div className="bg-white p-8 lg:p-12 rounded-3xl shadow-xl w-full max-w-sm lg:max-w-md border border-slate-100 animate-fade-in-up z-10">
                    <div className="mx-auto w-16 h-16 bg-white border border-slate-100 rounded-2xl shadow-lg flex items-center justify-center mb-6"><BapkamLogo className="w-10 h-10"/></div>
                    
                    {/* METHOD TABS */}
                    <div className="flex p-1 bg-slate-100 rounded-xl mb-6">
                        <button onClick={() => {setAuthMethod('email'); setError('');}} className={`flex-1 py-2 text-sm font-semibold rounded-lg transition-all ${authMethod === 'email' ? 'bg-white shadow text-slate-900' : 'text-slate-500 hover:text-slate-700'}`}>Email</button>
                        <button onClick={() => {setAuthMethod('phone'); setError('');}} className={`flex-1 py-2 text-sm font-semibold rounded-lg transition-all ${authMethod === 'phone' ? 'bg-white shadow text-slate-900' : 'text-slate-500 hover:text-slate-700'}`}>Phone</button>
                    </div>

                    <h1 className="text-2xl font-bold text-center text-slate-900 mb-6">
                        {authMethod === 'email' ? (view === 'signup' ? 'Create Account' : 'Welcome Back') : 'Verify Phone'}
                    </h1>

                    {authMethod === 'email' && (
                        <>
                            <form onSubmit={handleEmailSubmit} className="space-y-4">
                                {view === 'signup' && <input type="text" placeholder="Full Name" value={name} onChange={e=>setName(e.target.value)} className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 transition-shadow" required />}
                                <input type="email" placeholder="Email" value={email} onChange={e=>setEmail(e.target.value)} className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 transition-shadow" required />
                                <input type="password" placeholder="Password" value={password} onChange={e=>setPassword(e.target.value)} className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 transition-shadow" required />
                                <button type="submit" disabled={loading} className="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-black transition-all flex justify-center shadow-lg shadow-slate-900/20 items-center gap-2">
                                    <MailIcon className="w-4 h-4" />
                                    {loading ? 'Processing...' : (view==='signup'?'Sign Up':'Log In')}
                                </button>
                            </form>
                            <div className="text-xs text-center mt-6 text-slate-500 space-y-2">
                                {view === 'login' && <p>New here? <button onClick={()=>setView('signup')} className="font-bold text-blue-600 hover:underline">Sign Up</button></p>}
                                {view === 'signup' && <p>Have an account? <button onClick={()=>setView('login')} className="font-bold text-blue-600 hover:underline">Log In</button></p>}
                            </div>
                        </>
                    )}

                    {authMethod === 'phone' && (
                        <div className="space-y-4">
                            {!otpSent ? (
                                <form onSubmit={handleSendOtp} className="space-y-4">
                                    <div className="relative">
                                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                            <PhoneIcon className="w-5 h-5"/>
                                        </div>
                                        <input type="tel" placeholder="+1 555 000 0000" value={phoneNumber} onChange={e=>setPhoneNumber(e.target.value)} className="w-full bg-slate-50 border border-slate-200 rounded-xl pl-10 pr-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 transition-shadow" required />
                                    </div>
                                    <div id="recaptcha-container"></div>
                                    <button type="submit" disabled={loading} className="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-black transition-all flex justify-center shadow-lg shadow-slate-900/20">
                                        {loading ? 'Sending OTP...' : 'Send Code'}
                                    </button>
                                </form>
                            ) : (
                                <form onSubmit={handleVerifyOtp} className="space-y-4">
                                    <p className="text-sm text-center text-slate-500">Enter code sent to {phoneNumber}</p>
                                    <input type="text" placeholder="123456" value={otp} onChange={e=>setOtp(e.target.value)} className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 text-center tracking-widest text-lg font-mono" maxLength={6} required />
                                    <button type="submit" disabled={loading} className="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-black transition-all flex justify-center shadow-lg shadow-slate-900/20">
                                        {loading ? 'Verifying...' : 'Verify & Login'}
                                    </button>
                                    <button type="button" onClick={() => {setOtpSent(false); setOtp(''); setError('');}} className="w-full text-sm text-slate-500 hover:text-slate-800">Change Number</button>
                                </form>
                            )}
                        </div>
                    )}

                    {error && <div className="mt-4 p-3 bg-red-50 border border-red-100 rounded-lg select-all"><p className="text-xs text-red-600 text-center font-medium break-all">{error}</p></div>}
                
                    <div className="mt-8 pt-4 border-t border-slate-100">
                        <p className="text-xs text-slate-400 text-center mb-2">Firebase Configuration (Add to Authorized Domains)</p>
                        <div onClick={handleCopyDomain} className="bg-slate-50 border border-slate-200 p-3 rounded-lg flex items-center justify-between cursor-pointer hover:bg-slate-100 transition-colors group">
                            <span className="font-mono text-xs text-slate-600 truncate">{currentDomain}</span>
                            <span className="text-xs font-bold text-blue-600 group-hover:underline">Copy Domain</span>
                        </div>
                    </div>
                </div>
            </div>
        );
      };

      // --- MAIN APP ---
      const App = () => {
          const [isLoaded, setIsLoaded] = useState(false);
          const [user, setUser] = useState(null);
          const [sessions, setSessions] = useState([]);
          const [projects, setProjects] = useState([]);
          const [activeId, setActiveId] = useState(null); // Session ID
          const [currentView, setCurrentView] = useState('chat'); // 'chat', 'project-view'
          const [viewingProject, setViewingProject] = useState(null); // Project object
          
          const [input, setInput] = useState('');
          const [isSidebarOpen, setIsSidebarOpen] = useState(false);
          const [isStreaming, setIsStreaming] = useState(false);
          const [isProMode, setIsProMode] = useState(false);
          const [selectedAttachment, setSelectedAttachment] = useState(null);
          const [engineStatus, setEngineStatus] = useState('');
          const [toast, setToast] = useState(null);
          const [standaloneData, setStandaloneData] = useState(null);

          const chatRef = useRef(null);

          const getApiKey = useCallback(() => {
             const _k1 = "AIzaSyC12LW4wzw";
             const _k2 = "TPPtS6BekGUzv75QeO3H3u-A";
             return _k1 + _k2;
          }, []);

          // Init: Check URL for shared project
          useEffect(() => {
              const params = new URLSearchParams(window.location.search);
              const shareData = params.get('share');
              const type = params.get('type'); // 'webapp' or 'ebook'
              const mode = params.get('mode'); // 'standalone'
              
              if (shareData && mode === 'standalone') {
                  try {
                      const decompressed = LZString.decompressFromEncodedURIComponent(shareData);
                      if (decompressed) {
                          let data = { type: type || 'webapp' };
                          if (type === 'webapp') data.code = decompressed;
                          else if (type === 'ebook') data.content = JSON.parse(decompressed);
                          setStandaloneData(data);
                          setIsLoaded(true);
                          return;
                      }
                  } catch (e) {
                      console.error("Link invalid", e);
                  }
              }
          }, []);

          useEffect(() => {
              if (standaloneData) return;
              
              const unsubscribe = onAuthStateChanged(auth, (u) => {
                  if (u) {
                      setUser(u);
                  } else {
                      setUser(null);
                  }
                  setIsLoaded(true);
              });
              return () => unsubscribe();
          }, [standaloneData]);

          useEffect(() => {
              if (user && isLoaded && !standaloneData) {
                  // If it's a real user or guest, load data
                  const sKey = `bapkam_sessions_${user.uid}`;
                  const pKey = `bapkam_projects_${user.uid}`;
                  
                  const storedS = localStorage.getItem(sKey);
                  const storedP = localStorage.getItem(pKey);
                  
                  const parsedS = storedS ? JSON.parse(storedS) : [];
                  setSessions(parsedS);
                  if (parsedS.length > 0 && !activeId) setActiveId(parsedS[0].id);

                  const parsedP = storedP ? JSON.parse(storedP) : [];
                  setProjects(parsedP);
              }
          }, [user, isLoaded, standaloneData]);

          useEffect(() => {
              if (user && isLoaded && !standaloneData) {
                  localStorage.setItem(`bapkam_sessions_${user.uid}`, JSON.stringify(sessions));
                  localStorage.setItem(`bapkam_projects_${user.uid}`, JSON.stringify(projects));
              }
          }, [sessions, projects, user, isLoaded, standaloneData]);
          
          useEffect(() => {
             if (chatRef.current) chatRef.current.scrollTop = chatRef.current.scrollHeight;
          }, [sessions, activeId, isStreaming]);

          useEffect(() => {
              if (toast) {
                  const t = setTimeout(() => setToast(null), 3000);
                  return () => clearTimeout(t);
              }
          }, [toast]);

          const handleSignOut = () => {
              signOut(auth);
              setUser(null);
              setSessions([]);
              setProjects([]);
          };

          const createSession = () => {
              const id = Date.now().toString();
              const newS = { id, title: 'New Chat', messages: [] };
              setSessions(prev => [newS, ...prev]);
              setActiveId(id);
              setCurrentView('chat');
              if (window.innerWidth < 1024) setIsSidebarOpen(false);
          };

          const handleProjectCreated = (newProject) => {
              setProjects(prev => [newProject, ...prev]);
              setViewingProject(newProject);
              setCurrentView('project-view');
          };
          
          const handleShareProject = async (project) => {
              try {
                  let payload = '';
                  if (project.type === 'webapp') payload = project.code;
                  else if (project.type === 'ebook') payload = JSON.stringify(project.content);
                  
                  const compressed = LZString.compressToEncodedURIComponent(payload);
                  const url = `${window.location.origin}${window.location.pathname}?share=${compressed}&type=${project.type}&mode=standalone`;
                  await copyToClipboard(url);
                  setToast("Project link copied!");
              } catch (e) {
                  setToast("Project too large to share via link.");
              }
          };

          const attemptGeneration = async (key, contents, isPro, useTools = false) => {
             const modelsToTry = isPro 
                ? ['gemini-3-pro-preview', 'gemini-2.5-flash', 'gemini-1.5-pro'] 
                : ['gemini-2.5-flash', 'gemini-1.5-flash'];
             
             for (let i = 0; i < modelsToTry.length; i++) {
                 const model = modelsToTry[i];
                 try {
                     const normalInstruction = `You are Bapkam. 1. EMPATHETIC. 2. CONTEXTUAL. 3. SEARCH ENGINE SON (Use googleSearch for facts). 4. CODE EXPERT.`;
                     const proInstruction = `You are Bapkam PRO. Deep analysis. Perfect Markdown.`;
                     
                     let tools = [];
                     
                     if (useTools) {
                        tools = [
                          {
                            functionDeclarations: [
                              {
                                name: "generate_webapp",
                                description: "Generates a fully functional single-file HTML web application based on the user's request. The code must be self-contained in a single file.",
                                parameters: {
                                  type: Type.OBJECT,
                                  properties: {
                                    title: { type: Type.STRING, description: "The title of the application" },
                                    code: { type: Type.STRING, description: "The complete HTML code including <style> and <script> tags." }
                                  },
                                  required: ["title", "code"]
                                }
                              },
                              {
                                name: "generate_ebook",
                                description: "Generates a comprehensive ebook or novel with multiple pages.",
                                parameters: {
                                  type: Type.OBJECT,
                                  properties: {
                                    title: { type: Type.STRING },
                                    author: { type: Type.STRING },
                                    description: { type: Type.STRING, description: "A brief summary of the book" },
                                    pages: {
                                      type: Type.ARRAY,
                                      items: {
                                        type: Type.OBJECT,
                                        properties: {
                                          text: { type: Type.STRING, description: "The content of a single page (approx 300-500 words)" }
                                        }
                                      }
                                    }
                                  },
                                  required: ["title", "author", "pages"]
                                }
                              }
                            ]
                          }
                        ];
                     } else if (model.includes('flash') || model.includes('gemini-3-pro-preview')) {
                         tools.push({ googleSearch: {} });
                     }

                     const ai = new GoogleGenAI({ apiKey: key });
                     
                     // If we are using tools for generation, we generally want a single non-streaming response to parse the JSON easily,
                     // but the SDK supports streaming tools too. For simplicity with function calling attached to large text generation,
                     // we will use generateContent (non-streaming) for the 'create' commands to ensure valid JSON parsing.
                     if (useTools) {
                         const result = await ai.models.generateContent({
                            model: model,
                            contents: contents,
                            config: { 
                                systemInstruction: "You are an expert app developer and author. Use the provided tools to generate the requested content. Do not ask for clarification, just generate the best possible result.",
                                tools: tools 
                            }
                         });
                         return { type: 'tool', result: result };
                     } else {
                         const stream = await ai.models.generateContentStream({
                            model: model,
                            contents: contents,
                            config: { systemInstruction: isPro ? proInstruction : normalInstruction, tools: tools.length > 0 ? tools : undefined }
                         });
                         return { type: 'stream', stream: stream };
                     }
                 } catch (e) {
                     if (i === modelsToTry.length - 1) throw e;
                     await new Promise(r => setTimeout(r, 800));
                 }
             }
          };

          const handleSend = async (textOverride = null) => {
              const txt = textOverride || input;
              if (!txt.trim() && !selectedAttachment) return;
              const key = getApiKey();
              setInput(''); setSelectedAttachment(null); setIsStreaming(true);
              
              let currentId = activeId;
              if (!currentId) { currentId = Date.now().toString(); setActiveId(currentId); }
              
              setSessions(prev => {
                  const existing = prev.find(s => s.id === currentId);
                  const msg = { role: 'user', content: txt, attachments: selectedAttachment ? [selectedAttachment] : [] };
                  const ph = { role: 'model', content: '', isThinking: true };
                  if (existing) return prev.map(s => s.id === currentId ? { ...s, messages: [...s.messages, msg, ph] } : s);
                  return [{ id: currentId, title: txt.slice(0, 30) || 'New Chat', messages: [msg, ph] }, ...prev];
              });
              setEngineStatus("SON: SEARCHING...");

              // Detect Intent for Tools
              const lowerTxt = txt.toLowerCase();
              const isCreationRequest = /create|make|generate|write/.test(lowerTxt) && 
                                      (/website|web\s?app|app|page|site/.test(lowerTxt) || /book|novel|story|ebook/.test(lowerTxt));

              try {
                  const sess = sessions.find(s => s.id === currentId);
                  // Construct History (Simplified for this file)
                  let historyParts = sess ? sess.messages.filter(m => !m.isThinking && !m.isError).map(m => ({
                      role: m.role,
                      parts: [{ text: m.content }]
                  })) : [];
                  // Add current message
                  const contents = [...historyParts, { role: 'user', parts: [{ text: txt }] }];

                  if (isCreationRequest) {
                      setEngineStatus("GENERATING PROJECT...");
                      const response = await attemptGeneration(key, contents, isProMode, true);
                      
                      const fc = response.result.functionCalls?.[0];
                      if (fc) {
                           let newProject = null;
                           if (fc.name === 'generate_webapp') {
                               const args = fc.args;
                               let code = args.code;
                               // Cleanup code markdown if model added it inside the string
                               if (code.startsWith('```')) code = code.replace(/^```(html)?\n/, '').replace(/```$/, '');
                               newProject = { id: Date.now().toString(), type: 'webapp', title: args.title, code: code, date: new Date().toISOString() };
                           } else if (fc.name === 'generate_ebook') {
                               const args = fc.args;
                               newProject = { id: Date.now().toString(), type: 'ebook', title: args.title, content: args, date: new Date().toISOString() };
                           }

                           if (newProject) {
                               setProjects(prev => [newProject, ...prev]);
                               setSessions(prev => prev.map(s => s.id === currentId ? { ...s, messages: [...s.messages.slice(0, -1), { role: 'model', content: `I've created your ${newProject.type === 'webapp' ? 'website' : 'book'}: "${newProject.title}". Opening it now...`, isThinking: false }] } : s));
                               setViewingProject(newProject);
                               setTimeout(() => setCurrentView('project-view'), 500); // Small delay for UX
                           } else {
                               throw new Error("Failed to parse generation result.");
                           }
                      } else {
                          // Fallback if model didn't use tool
                          const text = response.result.text;
                          setSessions(prev => prev.map(s => s.id === currentId ? { ...s, messages: [...s.messages.slice(0, -1), { role: 'model', content: text, isThinking: false }] } : s));
                      }
                  } else {
                      const response = await attemptGeneration(key, contents, isProMode, false);
                      let fullText = '';
                      for await (const chunk of response.stream) {
                          fullText += chunk.text || '';
                          setSessions(prev => prev.map(s => s.id === currentId ? { ...s, messages: [...s.messages.slice(0, -1), { role: 'model', content: fullText, isThinking: false }] } : s));
                      }
                  }
              } catch (e) {
                  setSessions(prev => prev.map(s => s.id === currentId ? { ...s, messages: [...s.messages.slice(0, -1), { role: 'model', content: "Error: " + e.message, isError: true }] } : s));
              } finally {
                  setIsStreaming(false); setEngineStatus('');
              }
          };

          if (!isLoaded) return <div className="h-full w-full flex items-center justify-center bg-white"><div className="w-8 h-8 border-2 border-slate-200 border-t-slate-800 rounded-full animate-spin"/></div>;
          
          if (standaloneData) return <StandaloneViewer projectData={standaloneData} onClose={() => { window.history.pushState({}, '', window.location.pathname); setStandaloneData(null); }} />;
          
          if (!user) return <AuthScreen onLogin={() => {}} />;

          return (
              <div className="flex h-full w-full bg-white text-slate-900 font-sans relative overflow-hidden">
                  <div className={`fixed inset-0 bg-black/40 z-30 backdrop-blur-sm lg:hidden ${isSidebarOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`} onClick={() => setIsSidebarOpen(false)}></div>
                  
                  <aside className={`fixed lg:relative z-40 w-[280px] lg:w-[320px] h-full bg-slate-50 border-r border-slate-200 flex flex-col transition-transform duration-300 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0 shadow-2xl lg:shadow-none`}>
                      <div className="p-4 flex items-center justify-between">
                          <div className="flex items-center gap-2 font-bold text-lg"><BapkamLogo className="w-8 h-8"/> bapkam</div>
                          <button onClick={() => setIsSidebarOpen(false)} className="lg:hidden p-2"><CloseIcon className="w-5 h-5"/></button>
                      </div>
                      
                      <div className="px-4">
                        <div className="flex items-center justify-between px-4 py-3 bg-slate-100 rounded-xl mb-4 border border-slate-200">
                            <span className="text-sm font-bold text-slate-700 flex items-center gap-2">
                                <ZapIcon className={`w-4 h-4 ${isProMode ? 'text-yellow-500 fill-current' : 'text-slate-400'}`} />
                                Pro Mode
                            </span>
                            <button 
                                onClick={() => setIsProMode(!isProMode)} 
                                className={`w-10 h-6 rounded-full transition-colors relative ${isProMode ? 'bg-slate-900' : 'bg-slate-300'}`}
                            >
                                <div className={`absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform ${isProMode ? 'translate-x-4' : 'translate-x-0'}`} />
                            </button>
                        </div>
                      </div>

                      <div className="px-4 pb-2 space-y-2">
                          <button onClick={createSession} className="w-full py-2.5 bg-white border border-slate-200 rounded-lg shadow-sm font-semibold text-sm hover:border-slate-300 flex items-center justify-center gap-2 transition-all"><PlusIcon className="w-4 h-4"/> New Chat</button>
                      </div>
                      
                      <div className="flex-1 overflow-y-auto px-2 custom-scroll mt-4">
                          <div className="mb-6">
                              <h3 className="px-3 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Chats</h3>
                              {sessions.map(s => (
                                  <button key={s.id} onClick={() => {setActiveId(s.id); setCurrentView('chat'); setIsSidebarOpen(false);}} className={`w-full text-left px-3 py-2 rounded-lg text-sm mb-0.5 truncate transition-colors ${activeId===s.id && currentView==='chat' ? 'bg-white shadow-sm font-medium text-slate-900' : 'text-slate-600 hover:bg-slate-200/50'}`}>{s.title}</button>
                              ))}
                          </div>
                          <div>
                              <h3 className="px-3 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Projects</h3>
                              {projects.map(p => (
                                  <button key={p.id} onClick={() => {setViewingProject(p); setCurrentView('project-view'); setIsSidebarOpen(false);}} className={`w-full text-left px-3 py-2 rounded-lg text-sm mb-0.5 truncate transition-colors ${viewingProject?.id===p.id && currentView==='project-view' ? 'bg-white shadow-sm font-medium text-slate-900' : 'text-slate-600 hover:bg-slate-200/50'}`}>
                                      <span className="flex items-center gap-2">
                                          {p.type === 'webapp' ? <CodeIcon className="w-3 h-3 text-blue-500"/> : <BookIcon className="w-3 h-3 text-amber-500"/>}
                                          {p.title}
                                      </span>
                                  </button>
                              ))}
                              {projects.length === 0 && <p className="px-3 text-xs text-slate-400 italic">No projects yet.</p>}
                          </div>
                      </div>
                      
                      <div className="p-4 border-t border-slate-200">
                          <button onClick={handleSignOut} className="flex items-center gap-2 text-xs font-semibold text-slate-500 hover:text-red-600 w-full p-2 hover:bg-slate-100 rounded-lg transition-colors"><LogOutIcon className="w-4 h-4"/> Sign Out</button>
                      </div>
                  </aside>

                  <main className="flex-1 flex flex-col h-full relative min-w-0 bg-white">
                      
                      {currentView === 'project-view' && viewingProject && (
                           viewingProject.type === 'webapp' ? (
                               <div className="flex flex-col h-full">
                                    <div className="bg-white border-b border-slate-200 p-2 flex items-center justify-between">
                                        <div className="flex items-center gap-2 px-2">
                                            <span className="font-bold">{viewingProject.title}</span>
                                            <span className="text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded">App</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <button onClick={() => handleShareProject(viewingProject)} className="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 rounded text-xs font-bold flex items-center gap-1 transition-colors"><ShareIcon className="w-3 h-3"/> Share Link</button>
                                            <button onClick={() => setCurrentView('chat')} className="p-2 hover:bg-slate-100 rounded-full"><CloseIcon className="w-5 h-5"/></button>
                                        </div>
                                    </div>
                                    <div className="flex-1 bg-slate-100 overflow-hidden relative">
                                        <RunPreview code={viewingProject.code} language="html" onClose={()=>{}} onToast={setToast} isStandalone={true} />
                                    </div>
                               </div>
                           ) : (
                               <div className="h-full flex flex-col">
                                   <div className="bg-white border-b border-slate-200 p-2 flex items-center justify-between shrink-0 z-30">
                                       <div className="flex items-center gap-2 px-2">
                                            <span className="font-bold truncate max-w-[150px]">{viewingProject.title}</span>
                                            <span className="text-xs bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded">Book</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <button onClick={() => handleShareProject(viewingProject)} className="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 rounded text-xs font-bold flex items-center gap-1 transition-colors"><ShareIcon className="w-3 h-3"/> Share Link</button>
                                            <button onClick={() => setCurrentView('chat')} className="p-2 hover:bg-slate-100 rounded-full"><CloseIcon className="w-5 h-5"/></button>
                                        </div>
                                   </div>
                                   <div className="flex-1 overflow-hidden">
                                       <EBookViewer book={viewingProject.content} onClose={null} isStandalone={false} />
                                   </div>
                               </div>
                           )
                      )}

                      {currentView === 'chat' && (
                          <>
                            <header className="h-14 flex items-center justify-between px-4 border-b border-slate-100 bg-white/80 backdrop-blur sticky top-0 z-20">
                                <div className="flex items-center gap-3">
                                    <button onClick={() => setIsSidebarOpen(true)} className="lg:hidden p-2 -ml-2"><MenuIcon className="w-6 h-6 text-slate-700"/></button>
                                    <span className="font-bold lg:hidden">bapkam</span>
                                </div>
                            </header>
                            <div className="flex-1 overflow-y-auto custom-scroll p-4 lg:p-6 pb-24" ref={chatRef}>
                                {sessions.find(s=>s.id===activeId)?.messages.map((m, i) => (
                                    <div key={i} className={`flex mb-4 ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[85%] rounded-2xl px-5 py-3 text-sm lg:text-base shadow-sm ${m.role === 'user' ? 'bg-slate-100 text-slate-900 rounded-tr-none' : 'bg-white border border-slate-200 text-slate-800 rounded-tl-none'}`}>
                                            <div className="whitespace-pre-wrap">{m.content}</div>
                                        </div>
                                    </div>
                                ))}
                                {isStreaming && (
                                     <div className="flex mb-4 justify-start">
                                        <div className="bg-white border border-slate-200 rounded-2xl rounded-tl-none px-5 py-3 shadow-sm flex items-center gap-3">
                                             <div className="w-4 h-4 border-2 border-slate-200 border-t-slate-800 rounded-full animate-spin"></div>
                                             <span className="text-sm text-slate-500 font-medium tracking-wide text-xs">{engineStatus || "Thinking..."}</span>
                                        </div>
                                     </div>
                                )}
                            </div>
                            <div className="absolute bottom-0 left-0 right-0 p-4 bg-white/95 backdrop-blur border-t border-slate-100 z-30">
                                <div className="max-w-4xl mx-auto flex items-end gap-2 bg-slate-50 border border-slate-200 rounded-3xl p-2 focus-within:ring-2 focus-within:ring-slate-200 transition-all shadow-sm">
                                    <textarea value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => {if(e.key==='Enter' && !e.shiftKey){e.preventDefault(); handleSend();}}} placeholder={isProMode ? "Ask Bapkam Pro to create a website or write a novel..." : "Message Bapkam..."} className="flex-1 bg-transparent outline-none p-3 resize-none max-h-32 text-slate-800 placeholder-slate-400" rows={1}/>
                                    <button onClick={() => handleSend()} className={`p-3 rounded-full transition-all ${input.trim() ? 'bg-slate-900 text-white shadow-md' : 'bg-slate-100 text-slate-300'}`}><SendIcon className="w-5 h-5"/></button>
                                </div>
                            </div>
                          </>
                      )}
                  </main>
                  {toast && <div className="fixed top-4 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full font-bold shadow-lg z-50 animate-fade-in-up">{toast}</div>}
              </div>
          );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
  </body>
</html>